name: Continuous Deployment

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend

jobs:
  build-and-push-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Run tests
      working-directory: frontend
      run: npm run test:coverage
      env:
        CI: true
    
    - name: Build application
      working-directory: frontend
      run: npm run build
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  build-and-push-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Build and test with Maven
      working-directory: backend
      run: ./mvnw clean package
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push-frontend, build-and-push-backend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Verify secrets are configured
      run: |
        if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
          echo "❌ ERROR: EC2_SSH_KEY secret is not configured"
          echo "Please configure all required secrets in GitHub repository settings"
          echo "See GITHUB_SECRETS_TEMPLATE.md for details"
          exit 1
        fi
        if [ -z "${{ secrets.EC2_HOST }}" ]; then
          echo "❌ ERROR: EC2_HOST secret is not configured"
          exit 1
        fi
        if [ -z "${{ secrets.EC2_USER }}" ]; then
          echo "❌ ERROR: EC2_USER secret is not configured"
          exit 1
        fi
        echo "✅ All required secrets are configured"
    
    - name: Configure SSH
      run: |
        install -m 700 -d ~/.ssh
        printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Verify key format
        if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN.*PRIVATE KEY"; then
          echo "❌ ERROR: Invalid SSH key format"
          echo "The EC2_SSH_KEY secret doesn't appear to be a valid SSH private key"
          echo "Expected format: -----BEGIN ... PRIVATE KEY-----"
          exit 1
        fi
        
        # Add EC2 host to known_hosts
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp docker-compose.deploy.yml deploy/docker-compose.yml
        cp .env.production.example deploy/.env.example
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # Create .env file locally
        cat > deploy/.env << 'ENVFILE'
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
        WEBSOCKET_ALLOWED_ORIGINS=${{ secrets.WEBSOCKET_ALLOWED_ORIGINS }}
        REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
        REACT_APP_WS_URL=${{ secrets.REACT_APP_WS_URL }}
        ENVFILE
        
        # Copy files to EC2
        scp -i ~/.ssh/deploy_key deploy/docker-compose.yml $EC2_USER@$EC2_HOST:~/tictactoe/
        scp -i ~/.ssh/deploy_key deploy/.env $EC2_USER@$EC2_HOST:~/tictactoe/
        
        # Deploy on EC2
        ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'EOF'
          cd ~/tictactoe
          
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🚀 Starting deployment process..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Login to GitHub Container Registry
          echo "📦 Logging into GitHub Container Registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull latest images
          echo "⬇️  Pulling latest images..."
          docker-compose pull
          
          # Stop existing containers
          echo "⏹️  Stopping existing containers..."
          docker-compose down || true
          
          # Start new containers
          echo "▶️  Starting new containers..."
          docker-compose up -d
          
          echo ""
          echo "⏳ Waiting for services to start (this takes 2-3 minutes)..."
          echo ""
          
          # Wait and check periodically
          MAX_WAIT=180  # 3 minutes maximum
          ELAPSED=0
          INTERVAL=15   # Check every 15 seconds
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            
            RUNNING=$(docker-compose ps --services --filter "status=running" | wc -l)
            echo "[$ELAPSED seconds] Services running: $RUNNING/3"
            
            # If all 3 services are running, we're done
            if [ "$RUNNING" -eq 3 ]; then
              echo ""
              echo "✅ All services are running!"
              break
            fi
            
            # Show any container that's not running yet
            if [ "$RUNNING" -lt 3 ]; then
              NOT_RUNNING=$(docker-compose ps --services | while read service; do
                if ! docker-compose ps $service | grep -q "Up"; then
                  echo "  ⏳ $service still starting..."
                fi
              done)
              echo "$NOT_RUNNING"
            fi
          done
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 Final Service Status:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          docker-compose ps
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Final count
          RUNNING=$(docker-compose ps --services --filter "status=running" | wc -l)
          
          # Accept if at least backend and redis are running
          if [ "$RUNNING" -ge 2 ]; then
            echo ""
            echo "✅ Deployment successful! ($RUNNING/3 services running)"
            
            if [ "$RUNNING" -lt 3 ]; then
              echo ""
              echo "ℹ️  Note: Frontend may need a few more moments to fully start."
              echo "   The application will be fully available shortly."
            fi
          else
            echo ""
            echo "❌ Deployment failed: Only $RUNNING/3 services are running"
            echo ""
            echo "Recent logs:"
            docker-compose logs --tail=50
            exit 1
          fi
          
          # Cleanup old images
          echo ""
          echo "🧹 Cleaning up old images..."
          docker image prune -f
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Deployment completed!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        EOF
    
    - name: Verify deployment
      run: |
        echo "🔍 Running final deployment verification..."
        
        ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ~/tictactoe
          
          # Give it one more moment if needed
          sleep 10
          
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 Final Container Status:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          docker-compose ps
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Count running services
          RUNNING=$(docker-compose ps --services --filter "status=running" | wc -l)
          
          echo ""
          echo "Running services: $RUNNING/3"
          echo ""
          
          if [ "$RUNNING" -eq 3 ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "✅ PERFECT! All services are healthy and running!"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "🌐 Application is available at:"
            echo "   Frontend: http://${{ secrets.EC2_HOST }}"
            echo "   Backend:  http://${{ secrets.EC2_HOST }}:8080"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            exit 0
            
          elif [ "$RUNNING" -eq 2 ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "✅ DEPLOYMENT SUCCESSFUL (2/3 services running)"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "ℹ️  Note: Core services (backend + redis) are operational."
            echo "   Frontend may take a few more moments to be fully ready."
            echo ""
            echo "🌐 Application will be available at:"
            echo "   Frontend: http://${{ secrets.EC2_HOST }} (starting...)"
            echo "   Backend:  http://${{ secrets.EC2_HOST }}:8080 (ready)"
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Show which service is not running
            echo ""
            echo "Service status details:"
            for service in redis backend frontend; do
              if docker-compose ps $service | grep -q "Up"; then
                echo "  ✅ $service: Running"
              else
                echo "  ⏳ $service: Starting (may need more time)"
              fi
            done
            
            echo ""
            echo "Tip: SSH to EC2 and run 'docker-compose ps' to monitor startup"
            echo ""
            
            exit 0
            
          else
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ DEPLOYMENT FAILED: Critical services not running"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "Only $RUNNING/3 services are running. This is insufficient."
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Recent logs from all services:"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            docker-compose logs --tail=30
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            exit 1
          fi
        EOF
    
    - name: Cleanup SSH
      if: always()
      run: rm -f ~/.ssh/deploy_key
    
    - name: Deployment notification
      run: |
        echo "::notice::Successfully deployed version ${{ github.sha }} to production on EC2"